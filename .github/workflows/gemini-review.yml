# Gemini AI를 활용한 PR 코드 리뷰
name: Gemini Review

# PR이 생성되거나 업데이트될 때 실행
on:
  pull_request:
    types: [opened, synchronize]

# 같은 PR에 대해 중복 실행 방지 (새 커밋이 오면 이전 실행 취소)
concurrency:
  group: 'gemini-review-${{ github.event.pull_request.number }}'
  cancel-in-progress: true

jobs:
  review:
    name: Gemini AI Review
    runs-on: ubuntu-latest
    timeout-minutes: 7
    permissions:
      contents: read # 코드를 읽기 위해 필요
      pull-requests: write # PR에 리뷰 코멘트를 달기 위해 필요

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # 변경 사항(diff) 비교를 위해 전체 히스토리 필요

      - name: Run Gemini PR Review
        uses: google-github-actions/run-gemini-cli@v0
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PULL_REQUEST_NUMBER: ${{ github.event.pull_request.number }}
          REPOSITORY: ${{ github.repository }}
        with:
          gemini_api_key: ${{ secrets.GEMINI_API_KEY }}
          gemini_model: gemini-2.5-flash # 무료 티어에서 사용 가능한 모델
          # GitHub MCP 서버를 통해 PR에 리뷰 코멘트를 남길 수 있도록 설정
          settings: |-
            {
              "mcpServers": {
                "github": {
                  "command": "docker",
                  "args": [
                    "run", "-i", "--rm",
                    "-e", "GITHUB_PERSONAL_ACCESS_TOKEN",
                    "ghcr.io/github/github-mcp-server:v0.27.0"
                  ],
                  "includeTools": [
                    "add_comment_to_pending_review",
                    "pull_request_read",
                    "pull_request_review_write"
                  ],
                  "env": {
                    "GITHUB_PERSONAL_ACCESS_TOKEN": "${GITHUB_TOKEN}"
                  }
                }
              }
            }
          prompt: |
            ## 역할
            당신은 GitHub Pull Request 코드 리뷰어입니다.

            ## 입력 정보
            - GitHub 저장소: ${{ github.repository }}
            - PR 번호: ${{ github.event.pull_request.number }}

            ## 실행 순서
            1. pull_request_read 도구로 PR의 diff를 가져오세요.
            2. 변경된 코드를 분석하세요: 버그, 보안 이슈, 코드 품질, 개선 사항을 확인하세요.
            3. pull_request_review_write 도구로 PR에 리뷰를 제출하세요.
               - 리뷰 본문은 한국어로 작성하세요.
               - 변경 사항에 대한 요약과 피드백을 포함하세요.

            ## 리뷰 판정 기준
            아래 심각한 문제가 하나라도 있으면 event를 "REQUEST_CHANGES"로 제출하세요:
            - 버그 또는 런타임 에러를 유발하는 코드
            - 보안 취약점 (XSS, SQL Injection, 하드코딩된 시크릿 등)
            - 빌드 실패를 유발하는 코드

            위 문제가 없으면 event를 "APPROVE"로 제출하세요.
            단순한 스타일 개선이나 리팩토링 제안은 APPROVE하면서 코멘트로 남기세요.
